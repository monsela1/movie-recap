<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malis AI - Movie Studio V6 (Fixed Audio)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Kantumruy+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kantumruy Pro', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111827; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        
        /* Highlight selected mode */
        .mode-selected { border: 2px solid #eab308; background: #374151; color: #eab308; }
        .mode-default { border: 1px solid #374151; background: #1f2937; color: #9ca3af; }
    </style>
</head>
<body class="bg-black text-white min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- ICONS ---
        const Icons = {
            Mic: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Stop: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        };

        function App() {
            // --- STATE ---
            const [apiKey, setApiKey] = useState(localStorage.getItem("gemini_api_key") || "");
            const [videoFile, setVideoFile] = useState(null);
            const [videoUrl, setVideoUrl] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [status, setStatus] = useState("");
            const [translatedText, setTranslatedText] = useState("");
            const [step, setStep] = useState(apiKey ? 'main' : 'setup');
            
            // Mode: 'recap' (áŸá˜áŸ’ášá¶á™) vs 'dubbing' (á“á·á™á¶á™áá¶á˜áá½)
            const [mode, setMode] = useState('recap'); 
            
            const [isPlaying, setIsPlaying] = useState(false);
            const videoRef = useRef(null);

            // Save Key
            useEffect(() => {
                if(apiKey) localStorage.setItem("gemini_api_key", apiKey);
            }, [apiKey]);

            // --- AUDIO ENGINE (HYBRID: System + Google Fallback) ---
            const speakText = (text) => {
                window.speechSynthesis.cancel(); // Stop old audio
                setIsPlaying(true);

                // 1. Try Native Browser Voice (Best for Android)
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'km-KH'; 
                utterance.rate = 1.0; 

                // Check voices
                const voices = window.speechSynthesis.getVoices();
                const khmerVoice = voices.find(v => v.lang.includes('km'));
                if (khmerVoice) utterance.voice = khmerVoice;

                utterance.onend = () => setIsPlaying(false);
                utterance.onerror = (e) => {
                    console.error("System Voice Error", e);
                    // Fallback to Google Online if System fails
                    playGoogleFallback(text);
                };

                window.speechSynthesis.speak(utterance);
            };

            const playGoogleFallback = (text) => {
                // Split text because Google API limits length
                const chunks = text.match(/[^.!?áŸ”]+[.!?áŸ”]+/g) || [text];
                let index = 0;

                const playNext = () => {
                    if (index >= chunks.length) {
                        setIsPlaying(false);
                        return;
                    }
                    const chunk = chunks[index];
                    const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=km&q=${encodeURIComponent(chunk)}`;
                    const audio = new Audio(url);
                    audio.onended = () => {
                        index++;
                        playNext();
                    };
                    audio.onerror = () => {
                        alert("á˜á·á“á¢á¶á…áŠáŸ†áá¾ášá€á¶ášáŸá˜áŸ’á›áŸá„á”á¶á“ (Blocked)áŸ”");
                        setIsPlaying(false);
                    };
                    audio.play();
                };
                playNext();
            };

            const stopAudio = () => {
                window.speechSynthesis.cancel();
                setIsPlaying(false);
            };

            // --- MAIN LOGIC ---
            const handleProcess = async () => {
                if (!videoFile) return alert("áŸá¼á˜áŠá¶á€áŸ‹áœá¸áŠáŸá¢á¼áŸá·á“!");
                setIsProcessing(true);
                setTranslatedText(""); 
                stopAudio();

                try {
                    setStatus("ğŸš€ á€áŸ†á–á»á„á—áŸ’á‡á¶á”áŸ‹á‘áŸ… Gemini...");
                    
                    // Convert Video to Base64
                    const reader = new FileReader();
                    reader.readAsDataURL(videoFile);
                    reader.onload = async () => {
                        const base64Data = reader.result.split(',')[1];
                        
                        // --- PROMPT ENGINEERING (CRITICAL) ---
                        let systemPrompt = "";
                        
                        if (mode === 'recap') {
                            setStatus("ğŸ¿ á€áŸ†á–á»á„á”á„áŸ’á€á¾ááŸá¶á…áŸ‹ášá¿á„áŸá˜áŸ’ášá¶á™...");
                            systemPrompt = `
                                áá½á“á¶á‘á¸: á¢áŸ’á“á€á“á·á‘á¶á“ášá¿á„á—á¶á–á™á“áŸ’á (Movie Narrator)áŸ”
                                á€á·á…áŸ’á…á€á¶áš: á˜á¾á›áœá¸áŠáŸá¢á¼á“áŸáŸ‡ á á¾á™áŸášáŸáŸáš "á¢ááŸ’áá”á‘áŸá˜áŸ’ášá¶á™ášá¿á„" á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚ášáŸ”
                                á›á€áŸ’ááááŸ’áŒ:
                                1. áŸášáŸáŸášá‡á¶á€áá¶áááŸ’áŒ (Paragraph) á”áŸ‚á”á“á·á‘á¶á“ášá¿á„áŸ”
                                2. á”áŸ’ášá¾á–á¶á€áŸ’á™áŠá¼á…á‡á¶ "áŸá¶á…áŸ‹ášá¿á„á…á¶á”áŸ‹á•áŸ’áá¾á˜...", "áŸáŸ’ášá¶á”áŸ‹ááŸ‚...", "á”á“áŸ’á‘á¶á”áŸ‹á˜á€..."áŸ”
                                3. á˜á·á“ááŸ’ášá¼áœáŸášáŸáŸášáˆáŸ’á˜áŸ„áŸ‡áá½ (A:, B:) á‘áŸ á‚áºáŸášáŸáŸášášáŸ€á”ášá¶á”áŸ‹áŸá€á˜áŸ’á˜á—á¶á– á“á·á„á–á¶á€áŸ’á™á“á·á™á¶á™á”á‰áŸ’á…á¼á›á‚áŸ’á“á¶áŸ”
                            `;
                        } else {
                            setStatus("ğŸ™ï¸ á€áŸ†á–á»á„á”á€á”áŸ’ášáŸ‚á–á¶á€áŸ’á™áá½á¢á„áŸ’á‚ (Dubbing)...");
                            systemPrompt = `
                                áá½á“á¶á‘á¸: á¢áŸ’á“á€á”á€á”áŸ’ášáŸ‚ášá¿á„ (Dubbing Translator)áŸ”
                                á€á·á…áŸ’á…á€á¶áš: á”á€á”áŸ’ášáŸ‚ááŸ‚ "á–á¶á€áŸ’á™á“á·á™á¶á™ášá”áŸáŸ‹áá½á¢á„áŸ’á‚" á“áŸ…á€áŸ’á“á»á„áœá¸áŠáŸá¢á¼á“áŸáŸ‡á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚ášáŸ”
                                á›á€áŸ’ááááŸ’áŒ:
                                1. á á¶á˜áŸášáŸáŸášáŸá€á˜áŸ’á˜á—á¶á– (Action) áŸášáŸáŸášááŸ‚á–á¶á€áŸ’á™áŠáŸ‚á›á‚áŸá“á·á™á¶á™á”áŸ‰á»ááŸ’ááŸ„áŸ‡áŸ”
                                2. á”áŸ’ášá¾á—á¶áŸá¶á“á·á™á¶á™á’áŸ†áŸ— (Conversational Khmer) áŠá¼á…á‡á¶ "á¢á‰", "á¯á„", "á”á„", "á¢á¼á“"áŸ”
                                3. á”áŸ†á”áŸ‚á€áƒáŸ’á›á¶á“á·á™á¶á™á˜á½á™á”á“áŸ’á‘á¶ááŸ‹á˜áŸ’áá„áŸ— áŠá¾á˜áŸ’á”á¸á„á¶á™áŸáŸ’ášá½á›á”á‰áŸ’á…á¼á›áŸá˜áŸ’á›áŸá„áŸ”
                            `;
                        }

                        // Call Gemini
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [
                                            { text: systemPrompt },
                                            { inline_data: { mime_type: videoFile.type, data: base64Data } }
                                        ]
                                    }]
                                })
                            }
                        );

                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        const resultText = data.candidates[0].content.parts[0].text;
                        
                        setTranslatedText(resultText);
                        setStatus("âœ… ášá½á…ášá¶á›áŸ‹!");
                        
                        // Auto Play
                        speakText(resultText);
                    };

                } catch (e) {
                    alert("Error: " + e.message);
                    setStatus("âŒ á”ášá¶á‡áŸá™");
                } finally {
                    setIsProcessing(false);
                }
            };

            return (
                <div className="max-w-xl mx-auto p-4 pb-20">
                    <header className="flex justify-between items-center py-4 mb-6 border-b border-gray-800">
                        <h1 className="text-xl font-bold text-yellow-500">Malis AI <span className="text-xs text-gray-500">V6 (Sound Fixed)</span></h1>
                        {apiKey && <button onClick={() => {localStorage.removeItem("gemini_api_key"); window.location.reload();}} className="text-xs text-red-500">Log Out</button>}
                    </header>

                    {step === 'setup' ? (
                        <div className="bg-gray-900 p-6 rounded-2xl border border-gray-800 text-center">
                            <h2 className="text-lg font-bold mb-4">ğŸ”‘ á”á‰áŸ’á…á¼á› API Key</h2>
                            <input 
                                type="password" 
                                className="w-full bg-black border border-gray-700 p-3 rounded-lg text-white mb-4 text-center"
                                placeholder="Paste Gemini Key Here"
                                onChange={(e) => setApiKey(e.target.value)}
                            />
                            <button onClick={() => apiKey && setStep('main')} className="w-full bg-yellow-500 text-black font-bold py-3 rounded-lg">á…á¼á›á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹</button>
                        </div>
                    ) : (
                        <div className="space-y-6">
                            {/* 1. SELECT MODE */}
                            <div>
                                <label className="text-gray-400 text-xs uppercase font-bold mb-2 block">áŸ¡. á‡áŸ’ášá¾áŸášá¾áŸá”áŸ’ášá—áŸá‘ (Select Option)</label>
                                <div className="grid grid-cols-2 gap-3">
                                    <button 
                                        onClick={() => setMode('recap')}
                                        className={`p-4 rounded-xl flex flex-col items-center justify-center transition ${mode === 'recap' ? 'mode-selected' : 'mode-default'}`}
                                    >
                                        <Icons.Book />
                                        <span className="font-bold mt-2">áŸá˜áŸ’ášá¶á™ášá¿á„</span>
                                        <span className="text-[10px] opacity-70">Story Recap</span>
                                    </button>

                                    <button 
                                        onClick={() => setMode('dubbing')}
                                        className={`p-4 rounded-xl flex flex-col items-center justify-center transition ${mode === 'dubbing' ? 'mode-selected' : 'mode-default'}`}
                                    >
                                        <Icons.Mic />
                                        <span className="font-bold mt-2">á“á·á™á¶á™áá¶á˜áá½</span>
                                        <span className="text-[10px] opacity-70">Dubbing Script</span>
                                    </button>
                                </div>
                            </div>

                            {/* 2. UPLOAD */}
                            <div className="bg-gray-900 border border-gray-700 rounded-xl p-4">
                                {!videoUrl ? (
                                    <div className="relative h-32 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center">
                                        <p className="text-gray-500 text-sm">á…á»á…á‘á¸á“áŸáŸ‡ áŠá¾á˜áŸ’á”á¸áŠá¶á€áŸ‹áœá¸áŠáŸá¢á¼</p>
                                        <input type="file" accept="video/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => {
                                            const f = e.target.files[0];
                                            if(f) { setVideoFile(f); setVideoUrl(URL.createObjectURL(f)); }
                                        }} />
                                    </div>
                                ) : (
                                    <div className="relative">
                                        <video src={videoUrl} controls className="w-full rounded-lg max-h-60" />
                                        <button onClick={() => {setVideoUrl(null); setVideoFile(null);}} className="absolute top-2 right-2 bg-red-600 text-white p-1 rounded-full text-xs">Remove</button>
                                    </div>
                                )}
                            </div>

                            {/* 3. GENERATE BUTTON */}
                            <button 
                                onClick={handleProcess}
                                disabled={isProcessing || !videoFile}
                                className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg ${isProcessing ? 'bg-gray-700' : 'bg-gradient-to-r from-yellow-500 to-orange-600 text-black'}`}
                            >
                                {isProcessing ? status : (mode === 'recap' ? 'âœ¨ á…á¶á”áŸ‹á•áŸ’áá¾á˜áŸá˜áŸ’ášá¶á™' : 'ğŸ—£ï¸ á…á¶á”áŸ‹á•áŸ’áá¾á˜á”á€á”áŸ’ášáŸ‚')}
                            </button>

                            {/* 4. RESULT & AUDIO */}
                            {translatedText && (
                                <div className="bg-gray-900 border border-gray-700 rounded-xl p-4 animate-fade-in">
                                    <div className="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
                                        <h3 className="font-bold text-yellow-500">á›á‘áŸ’á’á•á› ({mode === 'recap' ? 'áŸá˜áŸ’ášá¶á™' : 'á“á·á™á¶á™áá¶á˜áá½'})</h3>
                                        <button 
                                            onClick={isPlaying ? stopAudio : () => speakText(translatedText)}
                                            className={`px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2 ${isPlaying ? 'bg-red-500 text-white' : 'bg-green-600 text-white'}`}
                                        >
                                            {isPlaying ? <><Icons.Stop /> áˆá”áŸ‹</> : <><Icons.Play /> áŸáŸ’áá¶á”áŸ‹</>}
                                        </button>
                                    </div>
                                    <div className="text-gray-300 whitespace-pre-line leading-relaxed text-lg max-h-96 overflow-y-auto custom-scrollbar">
                                        {translatedText}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
