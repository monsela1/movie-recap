<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malis AI - Studio V7 (Cinema Mode)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Kantumruy+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kantumruy Pro', sans-serif; background: #000; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        
        /* Cinema Mode Styles */
        .cinema-mode {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .subtitle-overlay {
            position: absolute; bottom: 10%; left: 5%; right: 5%;
            background: rgba(0,0,0,0.7); color: yellow;
            padding: 15px; border-radius: 10px;
            text-align: center; font-size: 18px; line-height: 1.6;
            text-shadow: 2px 2px 4px black;
            font-family: 'Battambang', cursive;
        }
    </style>
</head>
<body class="text-white min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- ICONS ---
        const Icons = {
            Mic: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Stop: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
            Cinema: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>,
            Close: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        };

        function App() {
            const [apiKey, setApiKey] = useState(localStorage.getItem("gemini_api_key") || "");
            const [videoFile, setVideoFile] = useState(null);
            const [videoUrl, setVideoUrl] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [status, setStatus] = useState("");
            const [translatedText, setTranslatedText] = useState("");
            const [step, setStep] = useState(apiKey ? 'main' : 'setup');
            const [mode, setMode] = useState('recap'); 
            const [isPlaying, setIsPlaying] = useState(false);
            const [isCinemaMode, setIsCinemaMode] = useState(false); // New Mode
            
            const videoRef = useRef(null);
            const cinemaVideoRef = useRef(null);

            useEffect(() => {
                if(apiKey) localStorage.setItem("gemini_api_key", apiKey);
            }, [apiKey]);

            // --- AUDIO ENGINE ---
            const speakText = (text) => {
                window.speechSynthesis.cancel();
                setIsPlaying(true);

                // Use System Voice (High Quality on Mobile)
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'km-KH'; 
                utterance.rate = 0.9; // Slightly slower for better dubbing feel

                const voices = window.speechSynthesis.getVoices();
                const khmerVoice = voices.find(v => v.lang.includes('km'));
                if (khmerVoice) utterance.voice = khmerVoice;

                utterance.onend = () => setIsPlaying(false);
                utterance.onerror = (e) => {
                    console.error("System Voice Failed", e);
                    playGoogleFallback(text); // Fallback
                };
                window.speechSynthesis.speak(utterance);
            };

            const playGoogleFallback = (text) => {
                const chunks = text.match(/[^.!?áŸ”]+[.!?áŸ”]+/g) || [text];
                let index = 0;
                const playNext = () => {
                    if (index >= chunks.length) { setIsPlaying(false); return; }
                    const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=km&q=${encodeURIComponent(chunks[index])}`;
                    const audio = new Audio(url);
                    audio.onended = () => { index++; playNext(); };
                    audio.onerror = () => setIsPlaying(false);
                    audio.play();
                };
                playNext();
            };

            const stopAudio = () => {
                window.speechSynthesis.cancel();
                setIsPlaying(false);
            };

            // --- ACTIONS ---
            const handleProcess = async () => {
                if (!videoFile) return alert("áŸá¼á˜áŠá¶á€áŸ‹áœá¸áŠáŸá¢á¼áŸá·á“!");
                setIsProcessing(true);
                stopAudio();

                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(videoFile);
                    reader.onload = async () => {
                        const base64Data = reader.result.split(',')[1];
                        
                        let systemPrompt = mode === 'recap' 
                            ? "áŸášáŸáŸášá¢ááŸ’áá”á‘áŸá˜áŸ’ášá¶á™ášá¿á„á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚áš (Narrative Style)áŸ” áŸášáŸáŸášá‡á¶á€áá¶áááŸ’áŒáŸ”" 
                            : "á”á€á”áŸ’ášáŸ‚á–á¶á€áŸ’á™á“á·á™á¶á™áá½á¢á„áŸ’á‚á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚áš (Dubbing Script)áŸ” áŸášáŸáŸášá‡á¶áƒáŸ’á›á¶ááŸ’á›á¸áŸ—áŸ”";

                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: systemPrompt }, { inline_data: { mime_type: videoFile.type, data: base64Data } }] }]
                                })
                            }
                        );
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        
                        const text = data.candidates[0].content.parts[0].text;
                        setTranslatedText(text);
                        speakText(text);
                    };
                } catch (e) {
                    alert("Error: " + e.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            const toggleCinemaMode = () => {
                if (!isCinemaMode) {
                    // Start Cinema
                    setIsCinemaMode(true);
                    stopAudio();
                    setTimeout(() => {
                        if (cinemaVideoRef.current) {
                            cinemaVideoRef.current.currentTime = 0;
                            cinemaVideoRef.current.play();
                            speakText(translatedText);
                        }
                    }, 500);
                } else {
                    // Stop Cinema
                    setIsCinemaMode(false);
                    stopAudio();
                }
            };

            return (
                <div className="max-w-xl mx-auto p-4 pb-20">
                    
                    {/* HEADER */}
                    <header className="flex justify-between items-center py-4 mb-6 border-b border-gray-800">
                        <h1 className="text-xl font-bold text-yellow-500">Malis AI <span className="text-xs text-white">V7</span></h1>
                        {apiKey && <button onClick={() => {localStorage.removeItem("gemini_api_key"); window.location.reload();}} className="text-xs text-red-500">Log Out</button>}
                    </header>

                    {/* SETUP */}
                    {step === 'setup' && (
                        <div className="bg-gray-900 p-6 rounded-2xl text-center">
                            <h2 className="text-lg font-bold mb-4">ğŸ”‘ á”á‰áŸ’á…á¼á› API Key</h2>
                            <input type="password" onChange={(e) => setApiKey(e.target.value)} className="w-full bg-black border border-gray-700 p-3 rounded-lg text-white mb-4 text-center" placeholder="Paste Key Here" />
                            <button onClick={() => apiKey && setStep('main')} className="w-full bg-yellow-500 text-black font-bold py-3 rounded-lg">á…á¼á›á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹</button>
                        </div>
                    )}

                    {/* MAIN UI */}
                    {step === 'main' && (
                        <div className="space-y-4">
                            {/* Mode Select */}
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => setMode('recap')} className={`p-3 rounded-xl border ${mode === 'recap' ? 'border-yellow-500 bg-gray-800 text-yellow-500' : 'border-gray-700 bg-gray-900 text-gray-400'}`}>ğŸ“– áŸá˜áŸ’ášá¶á™ášá¿á„</button>
                                <button onClick={() => setMode('dubbing')} className={`p-3 rounded-xl border ${mode === 'dubbing' ? 'border-yellow-500 bg-gray-800 text-yellow-500' : 'border-gray-700 bg-gray-900 text-gray-400'}`}>ğŸ™ï¸ á“á·á™á¶á™áá¶á˜áá½</button>
                            </div>

                            {/* Video Upload */}
                            <div className="bg-gray-900 border border-gray-700 rounded-xl overflow-hidden relative min-h-[150px] flex items-center justify-center">
                                {!videoUrl ? (
                                    <>
                                        <div className="text-center">
                                            <p className="text-gray-500">á…á»á…áŠá¾á˜áŸ’á”á¸áŠá¶á€áŸ‹áœá¸áŠáŸá¢á¼</p>
                                        </div>
                                        <input type="file" accept="video/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => {
                                            const f = e.target.files[0];
                                            if(f) { setVideoFile(f); setVideoUrl(URL.createObjectURL(f)); }
                                        }} />
                                    </>
                                ) : (
                                    <video ref={videoRef} src={videoUrl} controls className="w-full max-h-60" />
                                )}
                            </div>

                            {/* Generate Button */}
                            <button onClick={handleProcess} disabled={isProcessing || !videoFile} className={`w-full py-4 rounded-xl font-bold text-lg ${isProcessing ? 'bg-gray-700' : 'bg-gradient-to-r from-yellow-500 to-orange-600 text-black'}`}>
                                {isProcessing ? 'á€áŸ†á–á»á„á”á„áŸ’á€á¾á...' : 'âœ¨ á…á¶á”áŸ‹á•áŸ’áá¾á˜ (Start)'}
                            </button>

                            {/* Result Area */}
                            {translatedText && (
                                <div className="bg-gray-900 border border-gray-700 rounded-xl p-4">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold text-yellow-500">á›á‘áŸ’á’á•á›</h3>
                                        <div className="flex gap-2">
                                            <button onClick={() => speakText(translatedText)} className="text-xs bg-green-600 px-3 py-1 rounded">Play Audio</button>
                                            
                                            {/* CINEMA MODE BUTTON */}
                                            <button onClick={toggleCinemaMode} className="text-xs bg-red-600 text-white px-3 py-1 rounded flex items-center gap-1 animate-pulse font-bold">
                                                <Icons.Cinema /> ğŸ”´ Record Video
                                            </button>
                                        </div>
                                    </div>
                                    <div className="text-gray-400 text-sm max-h-40 overflow-y-auto">{translatedText}</div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* --- CINEMA MODE OVERLAY (FOR SCREEN RECORDING) --- */}
                    {isCinemaMode && videoUrl && (
                        <div className="cinema-mode">
                            {/* Video Container */}
                            <div className="relative w-full max-w-lg aspect-video">
                                <video 
                                    ref={cinemaVideoRef} 
                                    src={videoUrl} 
                                    className="w-full h-full object-contain"
                                    onEnded={() => setIsPlaying(false)}
                                />
                                
                                {/* Subtitle Overlay */}
                                <div className="subtitle-overlay">
                                    {translatedText}
                                </div>
                            </div>

                            {/* Close Button */}
                            <button onClick={toggleCinemaMode} className="absolute top-5 right-5 bg-white/20 p-2 rounded-full text-white hover:bg-white/40">
                                <Icons.Close />
                            </button>

                            <div className="absolute bottom-10 text-gray-500 text-xs animate-pulse">
                                ğŸ”´ áŸá¼á˜á”á¾á€ Screen Record á€áŸ’á“á»á„á‘á¼ášáŸáŸá–áŸ’á‘ášá”áŸáŸ‹á¢áŸ’á“á€á¥á¡á¼áœá“áŸáŸ‡
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
