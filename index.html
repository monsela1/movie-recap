<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malis AI - Movie Studio V5</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Kantumruy+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kantumruy Pro', sans-serif; }
        
        /* Scrollbar Styling */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111827; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }

        /* Button Styles */
        .btn-active { background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%); color: black; border: none; box-shadow: 0 4px 12px rgba(234, 179, 8, 0.3); }
        .btn-inactive { background: #1f2937; color: #9ca3af; border: 1px solid #374151; }
    </style>
</head>
<body class="bg-black text-white min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- ICONS ---
        const Icons = {
            Mic: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Stop: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
            Copy: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
        };

        function App() {
            // --- STATE ---
            const [apiKey, setApiKey] = useState(localStorage.getItem("gemini_api_key") || "");
            const [videoFile, setVideoFile] = useState(null);
            const [videoUrl, setVideoUrl] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [status, setStatus] = useState("");
            const [translatedText, setTranslatedText] = useState("");
            const [modelName, setModelName] = useState(""); 
            const [step, setStep] = useState(apiKey ? 'main' : 'setup');
            const [mode, setMode] = useState('recap'); // 'recap' or 'dubbing'
            const [isPlayingAudio, setIsPlayingAudio] = useState(false);
            const [copied, setCopied] = useState(false);

            const videoRef = useRef(null);
            const audioQueueRef = useRef([]);
            const currentAudioRef = useRef(null);

            // Save API Key locally
            useEffect(() => {
                if(apiKey) localStorage.setItem("gemini_api_key", apiKey);
            }, [apiKey]);

            // --- HELPER FUNCTIONS ---
            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 20 * 1024 * 1024) {
                        alert("âš ï¸ áŸá»áŸ†áœá¸áŠáŸá¢á¼á€áŸ’ášáŸ„á˜ 20MB áŸá·á“á”á„!");
                        return;
                    }
                    setVideoFile(file);
                    setVideoUrl(URL.createObjectURL(file));
                    setTranslatedText("");
                    setStatus("");
                    stopAudio();
                }
            };

            const fileToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = (error) => reject(error);
                });
            };

            const fetchAvailableModel = async (key) => {
                setStatus("ğŸ” á€áŸ†á–á»á„áŸáŸ’á€áŸá“ášá€áˆáŸ’á˜áŸ„áŸ‡ Model...");
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                    if (!response.ok) throw new Error("API Key á˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœ");

                    const data = await response.json();
                    const models = data.models
                        .filter(m => m.supportedGenerationMethods.includes("generateContent"))
                        .map(m => m.name.replace("models/", ""));

                    let bestModel = models.find(name => name.includes("flash") && !name.includes("exp")); // Prioritize Flash
                    if (!bestModel) bestModel = models.find(name => name.includes("pro") && !name.includes("exp"));
                    if (!bestModel && models.length > 0) bestModel = models[0];

                    if (!bestModel) throw new Error("ášá€á˜á·á“áƒá¾á‰ Model áá¶áŸáŸ„áŸ‡áŸ”");
                    setStatus(`âœ… ášá€áƒá¾á‰ Model: ${bestModel}`);
                    setModelName(bestModel);
                    return bestModel;
                } catch (e) {
                    throw new Error("á”ášá¶á‡áŸá™á€á¶ášáŸáŸ’á€áŸá“ Model: " + e.message);
                }
            };

            // --- AUDIO ENGINE ---
            const playGoogleTTS = (text) => {
                stopAudio();
                const sentences = text.match(/[^.!?áŸ”]+[.!?áŸ”]+/g) || [text];
                audioQueueRef.current = sentences;
                setIsPlayingAudio(true);
                playNextChunk();
            };

            const playNextChunk = () => {
                if (audioQueueRef.current.length === 0) {
                    setIsPlayingAudio(false);
                    return;
                }
                const chunk = audioQueueRef.current.shift().trim();
                if (!chunk) { playNextChunk(); return; }

                // Using client=tw-ob for better stability
                const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=km&q=${encodeURIComponent(chunk)}`;
                const audio = new Audio(url);
                currentAudioRef.current = audio;
                
                audio.onended = () => playNextChunk();
                audio.onerror = (e) => { console.error("Audio err", e); playNextChunk(); };
                
                audio.play().catch(e => {
                    console.error("Play failed", e);
                    setIsPlayingAudio(false);
                });
            };

            const stopAudio = () => {
                if (currentAudioRef.current) {
                    currentAudioRef.current.pause();
                    currentAudioRef.current = null;
                }
                audioQueueRef.current = [];
                setIsPlayingAudio(false);
            };

            // --- MAIN PROCESS ---
            const handleRealProcess = async () => {
                if (!apiKey || !videoFile) {
                    alert("áŸá¼á˜áŠá¶á€áŸ‹ API Key á“á·á„ áœá¸áŠáŸá¢á¼!");
                    return;
                }

                setIsProcessing(true);
                stopAudio();

                try {
                    let activeModel = modelName;
                    if (!activeModel) activeModel = await fetchAvailableModel(apiKey);
                    
                    const base64Data = await fileToBase64(videoFile);
                    
                    let systemPrompt = "";
                    if (mode === 'recap') {
                        setStatus(`ğŸ¿ AI (${activeModel}) á€áŸ†á–á»á„á”á„áŸ’á€á¾ááŸá¶á…áŸ‹ášá¿á„...`);
                        systemPrompt = `
                            áŠá¾ášáá½á‡á¶á¢áŸ’á“á€áŸá˜áŸ’ášá¶á™ášá¿á„ (Professional Movie Narrator)áŸ”
                            áŸá¼á˜áŸášáŸáŸášá¢ááŸ’áá”á‘áŸá˜áŸ’ášá¶á™ášá¿á„áŸá˜áŸ’ášá¶á”áŸ‹áœá¸áŠáŸá¢á¼á“áŸáŸ‡á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚ášá±áŸ’á™á˜á¶á“á“áŸá™ á“á·á„á‘á¶á€áŸ‹á‘á¶á‰á¢á¶ášá˜áŸ’á˜ááŸáŸ”
                            - á”áŸ’ášá¾á–á¶á€áŸ’á™á—áŸ’á‡á¶á”áŸ‹áƒáŸ’á›á¶á±áŸ’á™ášá›á¼á“ (Talkative & Engaging)áŸ”
                            - á˜á·á“á…á¶áŸ†á”á¶á…áŸ‹áŠá¶á€áŸ‹ TimecodeáŸ”
                            - áŸášáŸáŸášá‡á¶á€áá¶áááŸ’áŒ (Paragraph)áŸ”
                        `;
                    } else {
                        setStatus(`ğŸ—£ï¸ AI (${activeModel}) á€áŸ†á–á»á„á”á€á”áŸ’ášáŸ‚...`);
                        systemPrompt = `
                            áŠá¾ášáá½á‡á¶á¢áŸ’á“á€á”á€á”áŸ’ášáŸ‚á—á¶á–á™á“áŸ’á (Dubbing Translator)áŸ”
                            áŸá¼á˜á”á€á”áŸ’ášáŸ‚á€á¶ášáŸá“áŸ’á‘á“á¶á€áŸ’á“á»á„áœá¸áŠáŸá¢á¼á“áŸáŸ‡á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚áš áŠáŸ„á™á”áŸ’ášá¾á—á¶áŸá¶á“á·á™á¶á™á’á˜áŸ’á˜áá¶ (Natural Spoken Khmer)áŸ”
                            - á˜á·á“á”á¶á…áŸ‹áŠá¶á€áŸ‹áˆáŸ’á˜áŸ„áŸ‡áá½á¢á„áŸ’á‚ (A:, B:) á‘áŸáŸ”
                            - áŸášáŸáŸášáƒáŸ’á›á¶á‡á¶á”áŸ‹áŸ—á‚áŸ’á“á¶áŸ”
                            - á”áŸ’ášá¾á–á¶á€áŸ’á™ "á¢á‰, á¯á„, á”á„, á¢á¼á“" áá¶á˜á”ášá·á”á‘áŸ”
                        `;
                    }

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/${activeModel}:generateContent?key=${apiKey}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: systemPrompt },
                                        { inline_data: { mime_type: videoFile.type, data: base64Data } }
                                    ]
                                }],
                                safetySettings: [
                                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                                ]
                            })
                        }
                    );

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    if (!data.candidates || data.candidates.length === 0) throw new Error("AI á˜á·á“á†áŸ’á›á¾á™áá” (Blocked/Empty)");

                    const text = data.candidates[0].content.parts[0].text;
                    setTranslatedText(text);
                    setStatus("ğŸ‰ á‡áŸ„á‚á‡áŸá™!");
                    playGoogleTTS(text);

                } catch (error) {
                    console.error(error);
                    setStatus("âŒ " + error.message);
                    alert(error.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            const handlePlaySync = () => {
                if (videoRef.current) {
                    videoRef.current.currentTime = 0;
                    videoRef.current.muted = true;
                    videoRef.current.play();
                }
                playGoogleTTS(translatedText);
            };

            const handleCopy = () => {
                navigator.clipboard.writeText(translatedText);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            // --- RENDER ---
            return (
                <div className="min-h-screen pb-20 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-gray-900 via-black to-black text-gray-100 font-sans">
                    <header className="bg-black/50 backdrop-blur-md border-b border-gray-800 sticky top-0 z-50 px-4 py-4">
                        <div className="container mx-auto flex items-center justify-between max-w-xl">
                            <h1 className="text-xl font-bold text-yellow-500 flex items-center gap-2">
                                <span className="bg-yellow-500 text-black px-2 rounded text-sm">PRO</span> Malis Studio
                            </h1>
                            <div className="text-xs text-gray-500 font-mono">V5.1</div>
                        </div>
                    </header>

                    <main className="container mx-auto p-4 max-w-xl">
                        
                        {step === 'setup' && (
                            <div className="mt-10 bg-gray-900/50 p-8 rounded-3xl border border-gray-800 shadow-2xl text-center animate-fade-in">
                                <div className="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                </div>
                                <h2 className="text-2xl font-bold mb-2 text-white">á€á¶ášá€áŸ†áááŸ‹ (Setup)</h2>
                                <p className="text-gray-400 text-sm mb-6">áŸá¼á˜á”á‰áŸ’á…á¼á› Gemini API Key áŠá¾á˜áŸ’á”á¸á…á¶á”áŸ‹á•áŸ’áá¾á˜áŸ”</p>
                                
                                <input 
                                    type="password" 
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                    placeholder="Paste API Key Here..."
                                    className="w-full bg-black/50 border border-gray-700 rounded-xl p-4 text-white focus:ring-2 focus:ring-yellow-500 outline-none mb-4 text-center placeholder-gray-600 transition-all"
                                />
                                <button 
                                    onClick={() => apiKey ? setStep('main') : alert("áŸá¼á˜áŠá¶á€áŸ‹ Key áŸá·á“!")}
                                    className="w-full btn-active py-4 rounded-xl font-bold transition text-lg hover:brightness-110"
                                >
                                    á…á¶á”áŸ‹á•áŸ’áá¾á˜ ğŸš€
                                </button>
                                <p className="text-xs text-gray-600 mt-4">Key á“á¹á„ááŸ’ášá¼áœá”á¶á“ášá€áŸ’áŸá¶á‘á»á€á€áŸ’á“á»á„ Browser ášá”áŸáŸ‹á¢áŸ’á“á€áŸ”</p>
                            </div>
                        )}

                        {step === 'main' && (
                            <div className="space-y-6 mt-4 animate-fade-in">
                                
                                {/* 1. MODE SELECTION */}
                                <div className="grid grid-cols-2 gap-3 bg-gray-900/80 p-1.5 rounded-xl border border-gray-800">
                                    <button 
                                        onClick={() => setMode('recap')}
                                        className={`py-3 rounded-lg font-bold flex flex-col items-center justify-center transition ${mode === 'recap' ? 'bg-gray-700 text-yellow-400 shadow-sm' : 'text-gray-500 hover:text-gray-300'}`}
                                    >
                                        <Icons.Book />
                                        <span className="text-xs mt-1">áŸá˜áŸ’ášá¶á™ášá¿á„</span>
                                    </button>
                                    <button 
                                        onClick={() => setMode('dubbing')}
                                        className={`py-3 rounded-lg font-bold flex flex-col items-center justify-center transition ${mode === 'dubbing' ? 'bg-gray-700 text-yellow-400 shadow-sm' : 'text-gray-500 hover:text-gray-300'}`}
                                    >
                                        <Icons.Mic />
                                        <span className="text-xs mt-1">á“á·á™á¶á™áá¶á˜áá½</span>
                                    </button>
                                </div>

                                {/* 2. UPLOAD VIDEO */}
                                <div className={`border-2 border-dashed rounded-2xl bg-gray-900/30 relative group overflow-hidden transition-all ${videoUrl ? 'border-yellow-500/30' : 'border-gray-700 hover:border-gray-500'}`}>
                                    {!videoUrl ? (
                                        <div className="p-10 text-center cursor-pointer">
                                            <div className="mx-auto w-14 h-14 bg-gray-800 rounded-full flex items-center justify-center text-gray-400 mb-3 group-hover:scale-110 transition"><Icons.Upload /></div>
                                            <p className="text-gray-200 font-bold">áŠá¶á€áŸ‹áœá¸áŠáŸá¢á¼á“áŸ…á‘á¸á“áŸáŸ‡</p>
                                            <p className="text-xs text-gray-500 mt-1">MP4 (Max 20MB)</p>
                                        </div>
                                    ) : (
                                        <div className="relative aspect-video bg-black">
                                            <video ref={videoRef} src={videoUrl} className="w-full h-full object-contain" controls />
                                            <button onClick={() => {setVideoUrl(null); setVideoFile(null);}} className="absolute top-2 right-2 bg-black/70 text-white p-1 rounded-full hover:bg-red-600 transition">âœ•</button>
                                        </div>
                                    )}
                                    <input type="file" accept="video/*" onChange={handleFileChange} className="absolute inset-0 opacity-0 cursor-pointer" disabled={!!videoUrl} />
                                </div>

                                {/* 3. STATUS & ACTION */}
                                <div>
                                    {status && (
                                        <div className={`text-center text-xs font-mono mb-3 p-2 rounded-lg border ${status.includes('âŒ') ? 'bg-red-900/20 border-red-900 text-red-300' : 'bg-green-900/20 border-green-900 text-green-300'}`}>
                                            {status}
                                        </div>
                                    )}
                                    
                                    <button 
                                        onClick={handleRealProcess}
                                        disabled={isProcessing || !videoUrl}
                                        className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transition flex items-center justify-center gap-2 ${
                                            isProcessing || !videoUrl 
                                            ? 'bg-gray-800 text-gray-500 cursor-not-allowed' 
                                            : 'btn-active hover:scale-[1.01]'
                                        }`}
                                    >
                                        {isProcessing ? (
                                            <><span className="animate-spin text-xl">â³</span> á€áŸ†á–á»á„áŠáŸ†áá¾ášá€á¶áš...</>
                                        ) : (
                                            mode === 'recap' ? 'âœ¨ á”á„áŸ’á€á¾ááŸá˜áŸ’ášá¶á™ášá¿á„' : 'ğŸ™ï¸ á”á€á”áŸ’ášáŸ‚á“á·á™á¶á™áá¶á˜áá½'
                                        )}
                                    </button>
                                </div>

                                {/* 4. RESULT */}
                                {translatedText && (
                                    <div className="bg-gray-900/80 rounded-2xl p-5 border border-gray-800 animate-fade-in shadow-2xl relative overflow-hidden">
                                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-500 to-orange-600"></div>
                                        
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold text-gray-200 flex items-center gap-2">
                                                {mode === 'recap' ? 'ğŸ“œ á¢ááŸ’áá”á‘áŸá˜áŸ’ášá¶á™' : 'ğŸ’¬ á¢ááŸ’áá”á‘á“á·á™á¶á™'}
                                            </h3>
                                            
                                            <div className="flex gap-2">
                                                {/* Copy Button */}
                                                <button 
                                                    onClick={handleCopy}
                                                    className="px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 bg-gray-800 hover:bg-gray-700 text-white border border-gray-700 transition"
                                                >
                                                    {copied ? <Icons.Check /> : <Icons.Copy />}
                                                    {copied ? 'Copied' : 'Copy'}
                                                </button>

                                                {/* Play Button */}
                                                <button 
                                                    onClick={isPlayingAudio ? stopAudio : handlePlaySync} 
                                                    className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 transition ${isPlayingAudio ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`}
                                                >
                                                    {isPlayingAudio ? <><Icons.Stop /> áˆá”áŸ‹</> : <><Icons.Play /> áŸáŸ’áá¶á”áŸ‹</>}
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div className="text-gray-300 leading-8 font-khmer text-justify max-h-96 overflow-y-auto pr-2 custom-scrollbar text-lg whitespace-pre-line bg-black/20 p-4 rounded-xl border border-gray-800/50">
                                            {translatedText}
                                        </div>
                                    </div>
                                )}
                                
                                {translatedText && (
                                    <button onClick={() => window.location.reload()} className="w-full py-3 bg-gray-900 text-gray-500 rounded-xl font-medium hover:bg-gray-800 hover:text-white transition border border-gray-800 text-sm">
                                        ğŸ”„ á’áŸ’áœá¾áœá¸áŠáŸá¢á¼ááŸ’á˜á¸ (Reset)
                                    </button>
                                )}

                                <div className="text-center text-[10px] text-gray-700 mt-8 pb-8">
                                    Malis AI Studio â€¢ Powered by Gemini Flash
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
