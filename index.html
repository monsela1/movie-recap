<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malis AI - Movie Studio V5</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Kantumruy+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kantumruy Pro', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111827; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        .btn-active { background: linear-gradient(to right, #eab308, #ca8a04); color: black; border: none; }
        .btn-inactive { background: #1f2937; color: #9ca3af; border: 1px solid #374151; }
    </style>
</head>
<body class="bg-black text-white">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- ICONS ---
        const Icons = {
            Mic: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Stop: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
        };

        function App() {
            // --- STATE ---
            const [apiKey, setApiKey] = useState("");
            const [videoFile, setVideoFile] = useState(null);
            const [videoUrl, setVideoUrl] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [status, setStatus] = useState("");
            const [translatedText, setTranslatedText] = useState("");
            const [modelName, setModelName] = useState(""); 
            const [step, setStep] = useState('setup');
            const [mode, setMode] = useState('recap'); // 'recap' or 'dubbing'
            const [isPlayingAudio, setIsPlayingAudio] = useState(false);

            const videoRef = useRef(null);
            const audioQueueRef = useRef([]); // To store audio chunks
            const currentAudioRef = useRef(null); // Current playing audio object

            // --- HELPER FUNCTIONS ---

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 20 * 1024 * 1024) {
                        alert("áŸá»áŸ†áœá¸áŠáŸá¢á¼á€áŸ’ášáŸ„á˜ 20MB áŸá·á“á”á„!");
                        return;
                    }
                    setVideoFile(file);
                    setVideoUrl(URL.createObjectURL(file));
                    setTranslatedText("");
                    setStatus("");
                    stopAudio(); // Stop any previous audio
                }
            };

            const fileToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = (error) => reject(error);
                });
            };

            // Smart Model Scanner
            const fetchAvailableModel = async (key) => {
                setStatus("ğŸ” á€áŸ†á–á»á„áŸáŸ’á€áŸá“ášá€áˆáŸ’á˜áŸ„áŸ‡ Model...");
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                    if (!response.ok) throw new Error("API Key á˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœ");

                    const data = await response.json();
                    const models = data.models
                        .filter(m => m.supportedGenerationMethods.includes("generateContent"))
                        .map(m => m.name.replace("models/", ""));

                    // Logic: Flash + No Exp
                    let bestModel = models.find(name => name.includes("flash") && !name.includes("exp"));
                    if (!bestModel) bestModel = models.find(name => name.includes("pro") && !name.includes("exp"));
                    if (!bestModel) bestModel = models.find(name => !name.includes("exp"));
                    if (!bestModel && models.length > 0) bestModel = models[0];

                    if (!bestModel) throw new Error("ášá€á˜á·á“áƒá¾á‰ Model áá¶áŸáŸ„áŸ‡áŸ”");
                    setStatus(`âœ… ášá€áƒá¾á‰ Model: ${bestModel}`);
                    setModelName(bestModel);
                    return bestModel;
                } catch (e) {
                    throw new Error("á”ášá¶á‡áŸá™á€á¶ášáŸáŸ’á€áŸá“ Model: " + e.message);
                }
            };

            // --- AUDIO ENGINE (Server-Side TTS Hack) ---
            const playGoogleTTS = (text) => {
                stopAudio(); // Reset

                // 1. Split text into chunks < 200 chars (Google limit)
                // Split by punctuation to keep sentences natural
                const sentences = text.match(/[^.!?áŸ”]+[.!?áŸ”]+/g) || [text];
                
                audioQueueRef.current = sentences;
                setIsPlayingAudio(true);
                playNextChunk();
            };

            const playNextChunk = () => {
                if (audioQueueRef.current.length === 0) {
                    setIsPlayingAudio(false);
                    return;
                }

                const chunk = audioQueueRef.current.shift().trim();
                if (!chunk) {
                    playNextChunk();
                    return;
                }

                const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=km&q=${encodeURIComponent(chunk)}`;
                const audio = new Audio(url);
                currentAudioRef.current = audio;
                
                audio.onended = () => {
                    playNextChunk();
                };
                
                audio.onerror = (e) => {
                    console.error("Audio error", e);
                    playNextChunk(); // Skip error chunks
                };

                audio.play().catch(e => {
                    console.error("Play failed", e);
                    setIsPlayingAudio(false);
                });
            };

            const stopAudio = () => {
                if (currentAudioRef.current) {
                    currentAudioRef.current.pause();
                    currentAudioRef.current = null;
                }
                audioQueueRef.current = [];
                setIsPlayingAudio(false);
            };

            // --- MAIN PROCESS ---
            const handleRealProcess = async () => {
                if (!apiKey || !videoFile) {
                    alert("áŸá¼á˜áŠá¶á€áŸ‹ API Key á“á·á„ áœá¸áŠáŸá¢á¼!");
                    return;
                }

                setIsProcessing(true);
                stopAudio();

                try {
                    // 1. Scan Model
                    let activeModel = modelName;
                    if (!activeModel) {
                        activeModel = await fetchAvailableModel(apiKey);
                    }
                    
                    // 2. Convert Video
                    const base64Data = await fileToBase64(videoFile);
                    
                    // 3. Define Prompts based on MODE
                    let systemPrompt = "";
                    if (mode === 'recap') {
                        setStatus(`ğŸ¿ AI (${activeModel}) á€áŸ†á–á»á„áŸá˜áŸ’ášá¶á™ášá¿á„...`);
                        systemPrompt = `
                            áŠá¾ášáá½á‡á¶á¢áŸ’á“á€áŸá˜áŸ’ášá¶á™ášá¿á„ (Movie Narrator)áŸ”
                            áŸá¼á˜áŸášáŸáŸášá¢ááŸ’áá”á‘áŸá˜áŸ’ášá¶á™ášá¿á„áŸá˜áŸ’ášá¶á”áŸ‹áœá¸áŠáŸá¢á¼á“áŸáŸ‡á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚ášáŸ”
                            - á”áŸ’ášá¾á—á¶áŸá¶á“á·á‘á¶á“ášá¿á„á‘á¶á€áŸ‹á‘á¶á‰ (á§á‘á¶á ášááŸáŸ– "áŸá¶á…áŸ‹ášá¿á„á…á¶á”áŸ‹á•áŸ’áá¾á˜...", "áŸáŸ’ášá¶á”áŸ‹ááŸ‚...", "á—áŸ’á›á¶á˜á“áŸ„áŸ‡...")áŸ”
                            - á€á»áŸ†áŠá¶á€áŸ‹ Timecode áŸ”
                            - áŸášáŸáŸášá‡á¶á€áá¶áááŸ’áŒáœáŸ‚á„áŸ—áŸ”
                        `;
                    } else {
                        setStatus(`ğŸ—£ï¸ AI (${activeModel}) á€áŸ†á–á»á„á”á€á”áŸ’ášáŸ‚áá½á¢á„áŸ’á‚...`);
                        systemPrompt = `
                            áŠá¾ášáá½á‡á¶á¢áŸ’á“á€á”á€á”áŸ’ášáŸ‚á—á¶á–á™á“áŸ’á (Dubbing Translator)áŸ”
                            áŸá¼á˜á”á€á”áŸ’ášáŸ‚á–á¶á€áŸ’á™á“á·á™á¶á™ášá”áŸáŸ‹áá½á¢á„áŸ’á‚á€áŸ’á“á»á„áœá¸áŠáŸá¢á¼á“áŸáŸ‡á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚ášáŸ”
                            - á”á€á”áŸ’ášáŸ‚á¢áŸ„á™áŠá¼á…á–á¶á€áŸ’á™á“á·á™á¶á™á’á˜áŸ’á˜áá¶ (Talkative style)áŸ”
                            - á˜á·á“á”á¶á…áŸ‹áŠá¶á€áŸ‹áˆáŸ’á˜áŸ„áŸ‡áá½á¢á„áŸ’á‚ (A:, B:) á‘áŸ á‚áºáŸášáŸáŸášá–á¶á€áŸ’á™á“á·á™á¶á™á‡á¶á”áŸ‹áŸ—á‚áŸ’á“á¶áŸ”
                            - á”áŸ’ášá¾á–á¶á€áŸ’á™áŠá¼á…á‡á¶ "á¢á‰", "á¯á„", "á”á„", "á¢á¼á“" áá¶á˜á€á¶á›á‘áŸáŸáŸˆáŸ”
                        `;
                    }

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/${activeModel}:generateContent?key=${apiKey}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: systemPrompt },
                                        { inline_data: { mime_type: videoFile.type, data: base64Data } }
                                    ]
                                }],
                                safetySettings: [
                                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                                ]
                            })
                        }
                    );

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    if (!data.candidates || data.candidates.length === 0) throw new Error("AI á˜á·á“á†áŸ’á›á¾á™áá”");

                    const text = data.candidates[0].content.parts[0].text;
                    setTranslatedText(text);
                    setStatus("ğŸ‰ á‡áŸ„á‚á‡áŸá™!");
                    
                    // Auto Play Audio
                    playGoogleTTS(text);

                } catch (error) {
                    console.error(error);
                    setStatus("âŒ " + error.message);
                    alert(error.message);
                    setModelName(""); 
                } finally {
                    setIsProcessing(false);
                }
            };

            const handlePlaySync = () => {
                if (videoRef.current) {
                    videoRef.current.currentTime = 0;
                    videoRef.current.muted = true;
                    videoRef.current.play();
                }
                playGoogleTTS(translatedText);
            };

            return (
                <div className="min-h-screen bg-black text-gray-100 font-sans pb-20">
                    <header className="bg-gray-900/80 backdrop-blur-md border-b border-gray-800 sticky top-0 z-50 px-4 py-4">
                        <div className="container mx-auto flex items-center justify-between">
                            <h1 className="text-xl font-bold text-yellow-500 flex items-center gap-2">
                                <span className="bg-yellow-500 text-black px-2 rounded">AI</span> Studio V5
                            </h1>
                        </div>
                    </header>

                    <main className="container mx-auto p-4 max-w-xl">
                        
                        {step === 'setup' && (
                            <div className="mt-10 bg-gray-900 p-6 rounded-2xl border border-gray-800 shadow-xl text-center">
                                <h2 className="text-xl font-bold mb-2">ğŸ” á€á¶ášá€áŸ†áááŸ‹ (Setup)</h2>
                                <p className="text-gray-400 text-sm mb-6">á”á‰áŸ’á…á¼á› Gemini API Key áŠá¾á˜áŸ’á”á¸á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹áŸ”</p>
                                
                                <input 
                                    type="password" 
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                    placeholder="Paste Key Here..."
                                    className="w-full bg-black border border-gray-700 rounded-xl p-4 text-white focus:ring-2 focus:ring-yellow-500 outline-none mb-4 text-center"
                                />
                                <button 
                                    onClick={() => apiKey ? setStep('main') : alert("áŸá¼á˜áŠá¶á€áŸ‹ Key áŸá·á“!")}
                                    className="w-full bg-yellow-500 hover:bg-yellow-600 text-black py-4 rounded-xl font-bold transition text-lg"
                                >
                                    á…á¼á›á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹ ğŸš€
                                </button>
                            </div>
                        )}

                        {step === 'main' && (
                            <div className="space-y-6 mt-4">
                                
                                {/* 1. MODE SELECTION */}
                                <div className="grid grid-cols-2 gap-3 bg-gray-900 p-1 rounded-xl">
                                    <button 
                                        onClick={() => setMode('recap')}
                                        className={`py-3 rounded-lg font-bold flex flex-col items-center justify-center transition ${mode === 'recap' ? 'btn-active' : 'btn-inactive hover:bg-gray-800'}`}
                                    >
                                        <Icons.Book />
                                        <span className="text-xs mt-1">áŸá˜áŸ’ášá¶á™ášá¿á„</span>
                                    </button>
                                    <button 
                                        onClick={() => setMode('dubbing')}
                                        className={`py-3 rounded-lg font-bold flex flex-col items-center justify-center transition ${mode === 'dubbing' ? 'btn-active' : 'btn-inactive hover:bg-gray-800'}`}
                                    >
                                        <Icons.Mic />
                                        <span className="text-xs mt-1">á“á·á™á¶á™áá¶á˜áá½</span>
                                    </button>
                                </div>

                                {/* 2. UPLOAD VIDEO */}
                                <div className="border-2 border-dashed border-gray-700 rounded-2xl bg-gray-900 relative group overflow-hidden">
                                    {!videoUrl ? (
                                        <div className="p-8 text-center">
                                            <div className="mx-auto w-12 h-12 text-gray-500 mb-2"><Icons.Upload /></div>
                                            <p className="text-gray-300 font-bold">áŠá¶á€áŸ‹áœá¸áŠáŸá¢á¼á…á·á“á“áŸ…á‘á¸á“áŸáŸ‡</p>
                                            <p className="text-xs text-gray-500 mt-1">MP4 (Max 20MB)</p>
                                        </div>
                                    ) : (
                                        <div className="relative aspect-video bg-black">
                                            <video ref={videoRef} src={videoUrl} className="w-full h-full object-contain" controls />
                                        </div>
                                    )}
                                    <input type="file" accept="video/*" onChange={handleFileChange} className="absolute inset-0 opacity-0 cursor-pointer" />
                                </div>

                                {/* 3. ACTION & STATUS */}
                                <div>
                                    {status && (
                                        <div className={`text-center text-xs font-mono mb-2 p-2 rounded ${status.includes('âŒ') ? 'bg-red-900 text-red-200' : 'bg-green-900 text-green-200'}`}>
                                            {status}
                                        </div>
                                    )}
                                    
                                    <button 
                                        onClick={handleRealProcess}
                                        disabled={isProcessing || !videoUrl}
                                        className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transition flex items-center justify-center gap-2 ${
                                            isProcessing || !videoUrl 
                                            ? 'bg-gray-800 text-gray-500 cursor-not-allowed' 
                                            : 'bg-gradient-to-r from-yellow-500 to-orange-600 text-black hover:scale-[1.02]'
                                        }`}
                                    >
                                        {isProcessing ? 'â³ á€áŸ†á–á»á„á”á„áŸ’á€á¾á...' : (mode === 'recap' ? 'ğŸ¿ á”á„áŸ’á€á¾ááŸá˜áŸ’ášá¶á™ášá¿á„' : 'ğŸ—£ï¸ á”á€á”áŸ’ášáŸ‚á“á·á™á¶á™áá¶á˜áá½')}
                                    </button>
                                </div>

                                {/* 4. RESULT SCRIPT */}
                                {translatedText && (
                                    <div className="bg-gray-900 rounded-2xl p-5 border border-gray-800 animate-fade-in shadow-2xl">
                                        <div className="flex justify-between items-center mb-4 pb-4 border-b border-gray-800">
                                            <h3 className="font-bold text-yellow-500">
                                                {mode === 'recap' ? 'ğŸ“œ á¢ááŸ’áá”á‘áŸá˜áŸ’ášá¶á™' : 'ğŸ’¬ á¢ááŸ’áá”á‘á“á·á™á¶á™áá¶á˜áá½'}
                                            </h3>
                                            <button 
                                                onClick={isPlayingAudio ? stopAudio : handlePlaySync} 
                                                className={`px-4 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 transition ${isPlayingAudio ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`}
                                            >
                                                {isPlayingAudio ? <><Icons.Stop /> áˆá”áŸ‹</> : <><Icons.Play /> áŸáŸ’áá¶á”áŸ‹</>}
                                            </button>
                                        </div>
                                        <div className="text-gray-300 leading-8 font-khmer text-justify max-h-80 overflow-y-auto pr-2 custom-scrollbar text-lg whitespace-pre-line">
                                            {translatedText}
                                        </div>
                                    </div>
                                )}
                                
                                {translatedText && (
                                     <button onClick={() => window.location.reload()} className="w-full py-3 bg-gray-800 text-gray-400 rounded-xl font-medium hover:bg-gray-700 transition border border-gray-700">
                                        á’áŸ’áœá¾áœá¸áŠáŸá¢á¼ááŸ’á˜á¸ (Reset)
                                    </button>
                                )}

                                <div className="text-center text-[10px] text-gray-600 mt-8">
                                    Powered by Gemini V12 â€¢ TTS by Google
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
