<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malis AI - Gemini V12 Scanner</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Kantumruy+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kantumruy Pro', sans-serif; }
    </style>
</head>
<body class="bg-slate-900 text-white">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- ICONS ---
        const Icons = {
            Robot: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Volume: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
        };

        function App() {
            // --- STATE (·ûô·ûÄ·ûè·û∂·ûò·ûÄ·ûº·ûä·ûö·ûî·ûü·üã·û¢·üí·ûì·ûÄ) ---
            const [apiKey, setApiKey] = useState("");
            const [videoFile, setVideoFile] = useState(null);
            const [videoUrl, setVideoUrl] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [status, setStatus] = useState("");
            const [translatedText, setTranslatedText] = useState("");
            const [modelName, setModelName] = useState(""); 
            const [step, setStep] = useState('setup'); // setup, main

            const videoRef = useRef(null);

            // --- FUNCTIONS (·ûô·ûÄ·ûè·û∂·ûò·ûÄ·ûº·ûä·ûö·ûî·ûü·üã·û¢·üí·ûì·ûÄ) ---

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 20 * 1024 * 1024) {
                        alert("·ûü·ûª·üÜ·ûú·û∏·ûä·üÅ·û¢·ûº·ûÄ·üí·ûö·üÑ·ûò 20MB ·ûü·û∑·ûì·ûî·ûÑ!");
                        return;
                    }
                    setVideoFile(file);
                    setVideoUrl(URL.createObjectURL(file));
                    setTranslatedText("");
                    setStatus("");
                }
            };

            const fileToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = (error) => reject(error);
                });
            };

            // *** ·ûì·üÅ·üá·ûÇ·û∫·ûá·û∂·ûò·ûª·ûÅ·ûÑ·û∂·ûö·ûü·üí·ûì·ûº·ûõ·ûä·üÇ·ûõ·û¢·üí·ûì·ûÄ·ûü·ûö·ûü·üÅ·ûö (V12 Scanner) ***
            const fetchAvailableModel = async (key) => {
                setStatus("üîç ·ûÄ·üÜ·ûñ·ûª·ûÑ·ûü·üí·ûÄ·üÅ·ûì·ûö·ûÄ·ûà·üí·ûò·üÑ·üá Model...");
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                    if (!response.ok) throw new Error("API Key ·ûò·û∑·ûì·ûè·üí·ûö·ûπ·ûò·ûè·üí·ûö·ûº·ûú");

                    const data = await response.json();
                    
                    // Filter: ·ûô·ûÄ·ûè·üÇ·û¢·û∂·ûî·ûÑ·üí·ûÄ·ûæ·ûè·û¢·ûÄ·üí·ûü·ûö·ûî·û∂·ûì
                    const models = data.models
                        .filter(m => m.supportedGenerationMethods.includes("generateContent"))
                        .map(m => m.name.replace("models/", ""));

                    // Logic: Flash + No Exp
                    let bestModel = models.find(name => name.includes("flash") && !name.includes("exp"));
                    
                    // Fallback: Pro + No Exp
                    if (!bestModel) {
                        bestModel = models.find(name => name.includes("pro") && !name.includes("exp"));
                    }
                    // Fallback: Any + No Exp
                    if (!bestModel) {
                        bestModel = models.find(name => !name.includes("exp"));
                    }
                    // Last Resort
                    if (!bestModel && models.length > 0) bestModel = models[0];

                    if (!bestModel) throw new Error("·ûö·ûÄ·ûò·û∑·ûì·ûÉ·ûæ·ûâ Model ·ûé·û∂·ûü·üÑ·üá·üî");

                    setStatus(`‚úÖ ·ûö·ûÄ·ûÉ·ûæ·ûâ Model: ${bestModel}`);
                    setModelName(bestModel);
                    return bestModel;

                } catch (e) {
                    throw new Error("·ûî·ûö·û∂·ûá·üê·ûô·ûÄ·û∂·ûö·ûü·üí·ûÄ·üÅ·ûì Model: " + e.message);
                }
            };

            const handleRealProcess = async () => {
                if (!apiKey || !videoFile) {
                    alert("·ûü·ûº·ûò·ûä·û∂·ûÄ·üã API Key ·ûì·û∑·ûÑ ·ûú·û∏·ûä·üÅ·û¢·ûº!");
                    return;
                }

                setIsProcessing(true);
                setStatus("üöÄ ·ûÖ·û∂·ûî·üã·ûï·üí·ûè·ûæ·ûò...");

                try {
                    // 1. Scan Model
                    let activeModel = modelName;
                    if (!activeModel) {
                        activeModel = await fetchAvailableModel(apiKey);
                    }
                    
                    // 2. Convert Video
                    const base64Data = await fileToBase64(videoFile);
                    
                    // 3. Call Gemini
                    setStatus(`üß† AI (${activeModel}) ·ûÄ·üÜ·ûñ·ûª·ûÑ·ûò·ûæ·ûõ...`);
                    
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/${activeModel}:generateContent?key=${apiKey}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: "Describe this video and translate the summary to Khmer language. Return ONLY the Khmer translation in a storytelling style." },
                                        {
                                            inline_data: {
                                                mime_type: videoFile.type,
                                                data: base64Data
                                            }
                                        }
                                    ]
                                }],
                                safetySettings: [
                                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                                ]
                            })
                        }
                    );

                    const data = await response.json();

                    if (data.error) throw new Error(data.error.message);
                    if (!data.candidates || data.candidates.length === 0) throw new Error("AI ·ûò·û∑·ûì·ûÜ·üí·ûõ·ûæ·ûô·ûè·ûî");

                    const text = data.candidates[0].content.parts[0].text;
                    setTranslatedText(text);
                    setStatus("üéâ ·ûá·üÑ·ûÇ·ûá·üê·ûô!");
                    
                    // Auto Play Logic
                    speakText(text);

                } catch (error) {
                    console.error(error);
                    setStatus("‚ùå " + error.message);
                    alert(error.message);
                    // Reset model if failed
                    setModelName(""); 
                } finally {
                    setIsProcessing(false);
                }
            };

            // Native Browser TTS (More reliable than Google Link for Web Apps)
            const speakText = (text) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'km-KH';
                    const voices = window.speechSynthesis.getVoices();
                    const khmerVoice = voices.find(v => v.lang.includes('km'));
                    if (khmerVoice) utterance.voice = khmerVoice;
                    utterance.rate = 0.9;
                    window.speechSynthesis.speak(utterance);
                }
            };

            const handlePlayResult = () => {
                if (videoRef.current) {
                    videoRef.current.currentTime = 0;
                    videoRef.current.muted = true; // Mute video to hear AI
                    videoRef.current.play();
                }
                speakText(translatedText);
            };

            // --- RENDER UI ---
            return (
                <div className="min-h-screen bg-slate-900 text-white font-sans pb-20">
                    <header className="bg-slate-800/50 backdrop-blur-md border-b border-slate-700 sticky top-0 z-50 px-4 py-4">
                        <div className="container mx-auto flex items-center justify-between">
                            <h1 className="text-xl font-bold text-blue-400 flex items-center gap-2">
                                <Icons.Robot /> Malis AI <span className="text-xs bg-blue-900 text-blue-300 px-2 py-1 rounded-full">V12 Scanner</span>
                            </h1>
                        </div>
                    </header>

                    <main className="container mx-auto p-4 max-w-xl">
                        
                        {/* SETUP SCREEN */}
                        {step === 'setup' && (
                            <div className="mt-10 bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                                <h2 className="text-lg font-bold mb-4 text-center">üîê ·ûî·ûâ·üí·ûÖ·ûº·ûõ API Key</h2>
                                <input 
                                    type="password" 
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                    placeholder="Paste Gemini Key Here..."
                                    className="w-full bg-slate-900 border border-slate-600 rounded-xl p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none mb-4"
                                />
                                <button 
                                    onClick={() => apiKey ? setStep('main') : alert("·ûü·ûº·ûò·ûä·û∂·ûÄ·üã Key ·ûü·û∑·ûì!")}
                                    className="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-xl font-bold transition"
                                >
                                    ·ûÖ·û∂·ûî·üã·ûï·üí·ûè·ûæ·ûò
                                </button>
                                <p className="text-xs text-center text-gray-500 mt-4">Safe & Secure. Key stored in browser memory only.</p>
                            </div>
                        )}

                        {/* MAIN SCREEN */}
                        {step === 'main' && (
                            <div className="space-y-6 mt-6">
                                {/* UPLOAD BOX */}
                                <div className="border-2 border-dashed border-slate-700 rounded-2xl p-6 bg-slate-800/50 text-center relative group hover:border-blue-500 transition">
                                    {!videoUrl ? (
                                        <>
                                            <div className="mx-auto w-12 h-12 text-slate-500 mb-2 group-hover:text-blue-400"><Icons.Upload /></div>
                                            <p className="text-slate-300 font-medium">·ûÖ·ûª·ûÖ·ûë·û∏·ûì·üÅ·üá ·ûä·ûæ·ûò·üí·ûî·û∏·ûä·û∂·ûÄ·üã·ûú·û∏·ûä·üÅ·û¢·ûº</p>
                                            <p className="text-xs text-slate-500 mt-1">MP4 (Max 20MB)</p>
                                        </>
                                    ) : (
                                        <div className="relative aspect-video bg-black rounded-lg overflow-hidden">
                                            <video ref={videoRef} src={videoUrl} className="w-full h-full object-contain" controls />
                                        </div>
                                    )}
                                    <input type="file" accept="video/*" onChange={handleFileChange} className="absolute inset-0 opacity-0 cursor-pointer" />
                                </div>

                                {/* SCAN BUTTON & STATUS */}
                                <div>
                                    {status && (
                                        <div className={`text-center text-sm font-mono mb-2 p-2 rounded ${status.includes('‚ùå') ? 'bg-red-900/30 text-red-400' : 'bg-green-900/30 text-green-400'}`}>
                                            {status}
                                        </div>
                                    )}
                                    
                                    <button 
                                        onClick={handleRealProcess}
                                        disabled={isProcessing || !videoUrl}
                                        className={`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg transition ${
                                            isProcessing || !videoUrl 
                                            ? 'bg-slate-700 text-slate-500 cursor-not-allowed' 
                                            : 'bg-gradient-to-r from-blue-600 to-purple-600 hover:scale-[1.02]'
                                        }`}
                                    >
                                        {isProcessing ? '‚è≥ ·ûÄ·üÜ·ûñ·ûª·ûÑ·ûä·üÜ·ûé·ûæ·ûö·ûÄ·û∂·ûö...' : 'üöÄ ·ûü·üí·ûÄ·üÅ·ûì & ·ûü·ûò·üí·ûö·û∂·ûô·ûö·ûø·ûÑ'}
                                    </button>

                                    {modelName && (
                                        <div className="text-center mt-2 text-[10px] text-slate-500">
                                            Connected Model: <span className="text-blue-400 font-mono">{modelName}</span>
                                        </div>
                                    )}
                                </div>

                                {/* RESULT BOX */}
                                {translatedText && (
                                    <div className="bg-slate-800 rounded-2xl p-5 border border-slate-700 animate-fade-in shadow-2xl">
                                        <div className="flex justify-between items-center mb-3 pb-3 border-b border-slate-700">
                                            <h3 className="font-bold text-green-400">‚úÖ ·ûõ·ûë·üí·ûí·ûï·ûõ·ûü·ûò·üí·ûö·û∂·ûô</h3>
                                            <button onClick={handlePlayResult} className="bg-green-600 hover:bg-green-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                                <Icons.Play /> Play Again
                                            </button>
                                        </div>
                                        <div className="text-gray-200 leading-relaxed font-khmer text-justify max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                            {translatedText}
                                        </div>
                                    </div>
                                )}
                                
                                {translatedText && (
                                     <button onClick={() => window.location.reload()} className="w-full py-3 bg-slate-800 text-slate-400 rounded-xl font-medium hover:bg-slate-700 transition">
                                        ·ûí·üí·ûú·ûæ·ûú·û∏·ûä·üÅ·û¢·ûº·ûê·üí·ûò·û∏ (Reset)
                                    </button>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
