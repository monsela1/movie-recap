<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ·ûü·ûò·üí·ûö·û∂·ûô·ûö·ûø·ûÑ (Stable Version)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Kantumruy+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kantumruy Pro', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- ICONS ---
        const Icons = {
            Gemini: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Pause: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
            Loader: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Key: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>,
            Volume: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        };

        function App() {
            const [apiKey, setApiKey] = useState('');
            const [step, setStep] = useState('setup'); 
            const [status, setStatus] = useState('');
            const [videoFile, setVideoFile] = useState(null);
            const [videoUrl, setVideoUrl] = useState(null);
            const [script, setScript] = useState('');
            const [isPlaying, setIsPlaying] = useState(false);
            const [activeModel, setActiveModel] = useState('');
            
            const videoRef = useRef(null);

            // --- HELPER 1: Convert Video to Base64 ---
            const fileToGenerativePart = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result.split(',')[1];
                        resolve({
                            inlineData: {
                                data: base64String,
                                mimeType: file.type
                            }
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            // --- HELPER 2: ROBUST MODEL SCANNER (FIXED) ---
            const findBestModel = async (key) => {
                try {
                    setStatus("·ûÄ·üÜ·ûñ·ûª·ûÑ·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ Model ·ûä·üÇ·ûõ·ûò·û∂·ûì·ûü·üí·ûê·üÅ·ûö·ûó·û∂·ûñ...");
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error.message);
                    if (!data.models) throw new Error("·ûö·ûÄ·ûò·û∑·ûì·ûÉ·ûæ·ûâ Model ·ûé·û∂·ûò·ûΩ·ûô·ûë·üÅ");

                    const models = data.models;
                    
                    // Priority List: Stable Flash -> Latest Flash -> Pro -> Any Gemini
                    // We avoid "exp" (experimental) models to prevent quota errors
                    
                    let chosen = models.find(m => m.name.endsWith("gemini-1.5-flash")); // Best option
                    if (!chosen) chosen = models.find(m => m.name.endsWith("gemini-1.5-flash-latest"));
                    if (!chosen) chosen = models.find(m => m.name.endsWith("gemini-1.5-flash-001")); // Fallback Flash
                    if (!chosen) chosen = models.find(m => m.name.endsWith("gemini-1.5-pro")); // More expensive but works
                    
                    if (!chosen) throw new Error("·ûò·û∑·ûì·ûò·û∂·ûì Model ·ûü·ûò·üí·ûö·û∂·ûî·üã·ûú·û∏·ûä·üÅ·û¢·ûº·ûë·üÅ");
                    
                    // Remove 'models/' prefix if present to avoid double prefixing
                    const cleanName = chosen.name.replace('models/', '');
                    console.log("Selected Model:", cleanName);
                    return cleanName;

                } catch (e) {
                    console.error("Scan failed, using hard fallback:", e);
                    return "gemini-1.5-flash"; // Absolute backup
                }
            };

            // --- MAIN FUNCTION ---
            const callGemini = async () => {
                if (!apiKey) return alert("·ûü·ûº·ûò·ûî·ûâ·üí·ûÖ·ûº·ûõ Key ·ûá·û∂·ûò·ûª·ûì·ûü·û∑·ûì!");
                if (!videoFile) return alert("·ûü·ûº·ûò·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûú·û∏·ûä·üÅ·û¢·ûº!");
                
                if (videoFile.size > 20 * 1024 * 1024) {
                    return alert("·ûú·û∏·ûä·üÅ·û¢·ûº·ûí·üÜ·ûñ·üÅ·ûÄ! ·ûü·ûº·ûò·ûî·üí·ûö·ûæ·ûÄ·üí·ûö·üÑ·ûò 20MB·üî");
                }

                setStep('processing');
                
                try {
                    // 1. Scan for Model if not yet found
                    let modelToUse = activeModel;
                    if (!modelToUse) {
                        modelToUse = await findBestModel(apiKey);
                        setActiveModel(modelToUse);
                    }

                    setStatus(`·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·üí·ûö·ûæ: ${modelToUse}...`);

                    // 2. Prepare Video Data
                    const videoPart = await fileToGenerativePart(videoFile);

                    // 3. Generate Content
                    // IMPORTANT: Ensure no double 'models/' prefix
                    const finalModelName = modelToUse.startsWith('models/') ? modelToUse : `models/${modelToUse}`;
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/${finalModelName}:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: "You are a movie narrator. Watch this video and write a short, engaging recap script in Khmer language (Cambodian). Do NOT include timestamps. Just tell the story." },
                                    videoPart
                                ]
                            }]
                        })
                    });

                    const data = await response.json();
                    
                    // Handle Errors Gracefully
                    if (data.error) {
                        if (data.error.message.includes("quota")) {
                            throw new Error("·û¢·ûü·üã Quota ·û†·ûæ·ûô! ·ûü·ûº·ûò·ûö·ûÑ·üã·ûÖ·û∂·üÜ 2-3 ·ûì·û∂·ûë·û∏ ·û¨·ûî·üí·ûè·ûº·ûö Key ·ûê·üí·ûò·û∏·üî");
                        }
                        throw new Error(data.error.message);
                    }
                    
                    const generatedText = data.candidates[0].content.parts[0].text;
                    setScript(generatedText);
                    setStep('result');
                    speakText(generatedText);

                } catch (error) {
                    console.error(error);
                    alert("·ûî·ûö·û∂·ûá·üê·ûô: " + error.message);
                    setStep('upload');
                    setStatus('');
                    // Reset model if it failed, so we try scanning again next time
                    setActiveModel('');
                }
            };

            const speakText = (text) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'km-KH';
                    const voices = window.speechSynthesis.getVoices();
                    const khmerVoice = voices.find(v => v.lang.includes('km'));
                    if (khmerVoice) utterance.voice = khmerVoice;
                    utterance.rate = 0.9;
                    window.speechSynthesis.speak(utterance);
                }
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setVideoFile(file);
                    setVideoUrl(URL.createObjectURL(file));
                    setStep('upload');
                }
            };

            const togglePlay = () => {
                const vid = videoRef.current;
                if (vid) {
                    if (isPlaying) {
                        vid.pause();
                        window.speechSynthesis.pause();
                    } else {
                        vid.play();
                        window.speechSynthesis.resume();
                        if (!window.speechSynthesis.speaking && script) {
                            speakText(script);
                        }
                    }
                    setIsPlaying(!isPlaying);
                }
            };

            return (
                <div className="min-h-screen pb-10 bg-slate-50">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50 px-4 py-3 shadow-sm">
                        <div className="container mx-auto flex items-center justify-between">
                            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 flex items-center gap-2">
                                <span className="text-blue-600"><Icons.Gemini /></span> Gemini ·ûü·ûò·üí·ûö·û∂·ûô·ûö·ûø·ûÑ
                            </h1>
                            <span className="text-[10px] font-mono bg-green-100 text-green-700 px-2 py-1 rounded">Stable v3.0</span>
                        </div>
                    </header>

                    <main className="container mx-auto p-4 max-w-xl">
                        {step === 'setup' && (
                            <div className="bg-white p-6 rounded-2xl shadow-lg mt-8 animate-fade-in">
                                <div className="text-center mb-6">
                                    <div className="mx-auto bg-indigo-100 p-4 rounded-full w-16 h-16 flex items-center justify-center text-indigo-600 mb-4">
                                        <Icons.Key />
                                    </div>
                                    <h2 className="text-xl font-bold text-slate-800">Gemini API Key</h2>
                                    <p className="text-slate-500 text-sm mt-2">·ûî·ûâ·üí·ûÖ·ûº·ûõ Key ·ûä·ûæ·ûò·üí·ûî·û∏·û±·üí·ûô AI ·ûä·üÜ·ûé·ûæ·ûö·ûÄ·û∂·ûö·üî</p>
                                </div>
                                <input 
                                    type="password" 
                                    placeholder="·ûî·ûâ·üí·ûÖ·ûº·ûõ Gemini Key ·ûì·üÖ·ûë·û∏·ûì·üÅ·üá..." 
                                    className="w-full border border-slate-300 p-3 rounded-xl mb-4 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                />
                                <button 
                                    onClick={() => apiKey ? setStep('upload') : alert('·ûü·ûº·ûò·ûî·ûâ·üí·ûÖ·ûº·ûõ Key')}
                                    className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold transition"
                                >
                                    ·ûÖ·ûº·ûõ·ûî·üí·ûö·ûæ·ûî·üí·ûö·û∂·ûü·üã
                                </button>
                                <div className="mt-4 text-center">
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-blue-500 hover:underline">
                                        ·ûô·ûÄ Free Key ·ûì·üÖ·ûë·û∏·ûì·üÅ·üá (Google AI Studio)
                                    </a>
                                </div>
                            </div>
                        )}

                        {step === 'upload' && (
                            <div className="text-center mt-8">
                                <div className="border-2 border-dashed border-indigo-200 rounded-2xl p-8 bg-white hover:bg-indigo-50 transition">
                                    <input 
                                        type="file" 
                                        accept="video/*" 
                                        onChange={handleFileChange} 
                                        className="hidden" 
                                        id="videoUpload"
                                    />
                                    <label htmlFor="videoUpload" className="cursor-pointer block">
                                        <div className="mx-auto w-16 h-16 text-indigo-400 mb-3"><Icons.Upload /></div>
                                        <span className="text-indigo-700 font-bold text-lg">·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûú·û∏·ûä·üÅ·û¢·ûº</span>
                                        <p className="text-slate-400 text-sm mt-2">·ûú·û∏·ûä·üÅ·û¢·ûº·ûÅ·üí·ûõ·û∏ (·ûÄ·üí·ûö·üÑ·ûò 20MB)</p>
                                    </label>
                                </div>
                                {videoFile && (
                                    <div className="mt-6">
                                        <div className="bg-green-50 text-green-700 p-3 rounded-lg text-sm font-medium mb-4 flex items-center justify-center gap-2">
                                           ‚úÖ ·ûî·û∂·ûì·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü: {videoFile.name}
                                        </div>
                                        <button 
                                            onClick={callGemini}
                                            className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 text-lg active:scale-95 transition"
                                        >
                                            ·ûü·üí·ûÄ·üÅ·ûì & ·ûü·ûò·üí·ûö·û∂·ûô·ûö·ûø·ûÑ üöÄ
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}

                        {step === 'processing' && (
                            <div className="text-center mt-20">
                                <div className="animate-spin text-indigo-600 mx-auto w-16 h-16 mb-4"><Icons.Loader /></div>
                                <h2 className="text-xl font-bold text-slate-800">·ûÄ·üÜ·ûñ·ûª·ûÑ·ûä·üÜ·ûé·ûæ·ûö·ûÄ·û∂·ûö...</h2>
                                <p className="text-indigo-600 animate-pulse mt-2 font-medium">{status}</p>
                                <div className="mt-8 text-center">
                                    <span className="text-[10px] text-gray-400 border px-2 py-1 rounded-full">
                                        Model: {activeModel || 'Auto-Detecting...'}
                                    </span>
                                </div>
                            </div>
                        )}

                        {step === 'result' && (
                            <div className="space-y-6 mt-4 pb-20">
                                <div className="bg-black rounded-2xl overflow-hidden shadow-2xl relative aspect-[9/16] max-w-sm mx-auto border-4 border-white">
                                    <video 
                                        ref={videoRef}
                                        src={videoUrl}
                                        className="w-full h-full object-cover"
                                        playsInline
                                        loop
                                        muted
                                    />
                                    {!isPlaying && (
                                        <div 
                                            className="absolute inset-0 bg-black/40 flex items-center justify-center cursor-pointer backdrop-blur-[1px]"
                                            onClick={togglePlay}
                                        >
                                            <div className="text-white transform scale-150 drop-shadow-lg"><Icons.Play /></div>
                                        </div>
                                    )}
                                </div>
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                            <Icons.Gemini /> ·ûü·ûò·üí·ûö·û∂·ûô·ûä·üÑ·ûô AI
                                        </h3>
                                        <button onClick={() => speakText(script)} className="text-blue-600 bg-blue-50 p-2 rounded-full hover:bg-blue-100">
                                            <Icons.Volume />
                                        </button>
                                    </div>
                                    <div className="text-slate-700 leading-8 font-khmer bg-slate-50 p-4 rounded-xl text-base text-justify">
                                        {script}
                                    </div>
                                </div>
                                <button onClick={() => window.location.reload()} className="w-full py-3 bg-slate-200 hover:bg-slate-300 rounded-xl font-bold text-slate-600 transition">
                                    ·ûí·üí·ûú·ûæ·ûú·û∏·ûä·üÅ·û¢·ûº·ûê·üí·ûò·û∏
                                </button>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
