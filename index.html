<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malis AI - áŸá˜áŸ’ášá¶á™ášá¿á„ Pro</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Kantumruy+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kantumruy Pro', sans-serif; }
        /* Custom Scrollbar for Script Box */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-900 text-white">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- ICONS ---
        const Icons = {
            Movie: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Volume: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
        };

        function App() {
            // --- STATE ---
            const [apiKey, setApiKey] = useState("");
            const [videoFile, setVideoFile] = useState(null);
            const [videoUrl, setVideoUrl] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [status, setStatus] = useState("");
            const [translatedText, setTranslatedText] = useState("");
            const [modelName, setModelName] = useState(""); 
            const [step, setStep] = useState('setup');

            const videoRef = useRef(null);

            // --- FUNCTIONS ---

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 20 * 1024 * 1024) {
                        alert("áŸá»áŸ†áœá¸áŠáŸá¢á¼á€áŸ’ášáŸ„á˜ 20MB áŸá·á“á”á„!");
                        return;
                    }
                    setVideoFile(file);
                    setVideoUrl(URL.createObjectURL(file));
                    setTranslatedText("");
                    setStatus("");
                }
            };

            const fileToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = (error) => reject(error);
                });
            };

            // V12 Scanner: ášá€ Model áŠáŸ‚á›á›áŸ’á¢á”áŸ†á•á»á
            const fetchAvailableModel = async (key) => {
                setStatus("ğŸ” á€áŸ†á–á»á„áŸáŸ’á€áŸá“ášá€áˆáŸ’á˜áŸ„áŸ‡ Model...");
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                    if (!response.ok) throw new Error("API Key á˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœ");

                    const data = await response.json();
                    
                    const models = data.models
                        .filter(m => m.supportedGenerationMethods.includes("generateContent"))
                        .map(m => m.name.replace("models/", ""));

                    // Logic: Flash + No Exp (Stable)
                    let bestModel = models.find(name => name.includes("flash") && !name.includes("exp"));
                    if (!bestModel) bestModel = models.find(name => name.includes("pro") && !name.includes("exp"));
                    if (!bestModel) bestModel = models.find(name => !name.includes("exp"));
                    if (!bestModel && models.length > 0) bestModel = models[0];

                    if (!bestModel) throw new Error("ášá€á˜á·á“áƒá¾á‰ Model áá¶áŸáŸ„áŸ‡áŸ”");

                    setStatus(`âœ… ášá€áƒá¾á‰ Model: ${bestModel}`);
                    setModelName(bestModel);
                    return bestModel;

                } catch (e) {
                    throw new Error("á”ášá¶á‡áŸá™á€á¶ášáŸáŸ’á€áŸá“ Model: " + e.message);
                }
            };

            const handleRealProcess = async () => {
                if (!apiKey || !videoFile) {
                    alert("áŸá¼á˜áŠá¶á€áŸ‹ API Key á“á·á„ áœá¸áŠáŸá¢á¼!");
                    return;
                }

                setIsProcessing(true);
                setStatus("ğŸš€ á…á¶á”áŸ‹á•áŸ’áá¾á˜...");

                try {
                    // 1. Scan Model
                    let activeModel = modelName;
                    if (!activeModel) {
                        activeModel = await fetchAvailableModel(apiKey);
                    }
                    
                    // 2. Convert Video
                    const base64Data = await fileToBase64(videoFile);
                    
                    // 3. Call Gemini (áŸá˜áŸ’ášá¶á™ášá¿á„ Prompt)
                    setStatus(`ğŸ¿ AI (${activeModel}) á€áŸ†á–á»á„áŸá˜áŸ’ášá¶á™ášá¿á„...`);
                    
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/${activeModel}:generateContent?key=${apiKey}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        // --- á€á“áŸ’á›áŸ‚á„áŸáŸ†áá¶á“áŸ‹á”áŸ†á•á»ááŸ– á”áŸ’áá¼áš Prompt á±áŸ’á™á‘áŸ…á‡á¶á¢áŸ’á“á€áŸá˜áŸ’ášá¶á™ášá¿á„ ---
                                        { text: `
                                            áŠá¾ášáá½á‡á¶á¢áŸ’á“á€áŸá˜áŸ’ášá¶á™ášá¿á„ááŸ’áŸáŸ‚á—á¶á–á™á“áŸ’ááŠáŸá–á¼á€áŸ‚ á“á·á„á˜á¶á“á”áŸ’ášá‡á¶á”áŸ’ášá·á™á—á¶á–áŸ”
                                            áŸá¼á˜á˜á¾á›áœá¸áŠáŸá¢á¼á“áŸáŸ‡ á á¾á™áŸášáŸáŸášá¢ááŸ’áá”á‘áŸá˜áŸ’ášá¶á™ášá¿á„ (Movie Recap) á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚ášáŸ”
                                            
                                            á›á€áŸ’ááááŸ’áŒáŸ–
                                            1. á”áŸ’ášá¾á—á¶áŸá¶á“á·á‘á¶á“ášá¿á„áŠáŸ‚á›á‘á¶á€áŸ‹á‘á¶á‰ (á§á‘á¶á ášááŸáŸ– "áŸá¶á…áŸ‹ášá¿á„á…á¶á”áŸ‹á•áŸ’áá¾á˜á¡á¾á„...", "á”á»ášáŸá˜áŸ’á“á¶á€áŸ‹á“áŸáŸ‡áˆáŸ’á˜áŸ„áŸ‡...", "á—áŸ’á›á¶á˜á“áŸ„áŸ‡...")áŸ”
                                            2. á˜á·á“á”á¶á…áŸ‹áŠá¶á€áŸ‹ Timecode (00:01) á‘áŸáŸ”
                                            3. á•áŸ’ááŸ„áá›á¾áŸá€á˜áŸ’á˜á—á¶á–áŸáŸ†áá¶á“áŸ‹áŸ— á“á·á„á¢á¶ášá˜áŸ’á˜ááŸáá½á¢á„áŸ’á‚áŸ”
                                            4. áŸášáŸáŸášá‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚áš áŸ¡áŸ áŸ %áŸ”
                                        ` },
                                        {
                                            inline_data: {
                                                mime_type: videoFile.type,
                                                data: base64Data
                                            }
                                        }
                                    ]
                                }],
                                safetySettings: [
                                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                                ]
                            })
                        }
                    );

                    const data = await response.json();

                    if (data.error) throw new Error(data.error.message);
                    if (!data.candidates || data.candidates.length === 0) throw new Error("AI á˜á·á“á†áŸ’á›á¾á™áá”");

                    const text = data.candidates[0].content.parts[0].text;
                    setTranslatedText(text);
                    setStatus("ğŸ‰ á‡áŸ„á‚á‡áŸá™!");
                    
                    speakText(text);

                } catch (error) {
                    console.error(error);
                    setStatus("âŒ " + error.message);
                    alert(error.message);
                    setModelName(""); 
                } finally {
                    setIsProcessing(false);
                }
            };

            const speakText = (text) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'km-KH';
                    // Try to find Khmer voice (Android usually has it)
                    const voices = window.speechSynthesis.getVoices();
                    const khmerVoice = voices.find(v => v.lang.includes('km'));
                    if (khmerVoice) utterance.voice = khmerVoice;
                    
                    utterance.rate = 1.0; // Normal speed for narration
                    window.speechSynthesis.speak(utterance);
                }
            };

            const handlePlayResult = () => {
                if (videoRef.current) {
                    videoRef.current.currentTime = 0;
                    videoRef.current.muted = true;
                    videoRef.current.play();
                }
                speakText(translatedText);
            };

            return (
                <div className="min-h-screen bg-slate-900 text-white font-sans pb-20">
                    <header className="bg-slate-800/50 backdrop-blur-md border-b border-slate-700 sticky top-0 z-50 px-4 py-4">
                        <div className="container mx-auto flex items-center justify-between">
                            <h1 className="text-xl font-bold text-yellow-400 flex items-center gap-2">
                                <Icons.Movie /> áŸá˜áŸ’ášá¶á™ášá¿á„ <span className="text-white">Pro</span>
                            </h1>
                        </div>
                    </header>

                    <main className="container mx-auto p-4 max-w-xl">
                        
                        {step === 'setup' && (
                            <div className="mt-10 bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                                <h2 className="text-lg font-bold mb-4 text-center">ğŸ” á”á‰áŸ’á…á¼á› API Key</h2>
                                <input 
                                    type="password" 
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                    placeholder="Paste Gemini Key Here..."
                                    className="w-full bg-slate-900 border border-slate-600 rounded-xl p-3 text-white focus:ring-2 focus:ring-yellow-500 outline-none mb-4"
                                />
                                <button 
                                    onClick={() => apiKey ? setStep('main') : alert("áŸá¼á˜áŠá¶á€áŸ‹ Key áŸá·á“!")}
                                    className="w-full bg-yellow-500 hover:bg-yellow-600 text-black py-3 rounded-xl font-bold transition"
                                >
                                    á…á¶á”áŸ‹á•áŸ’áá¾á˜áŸá˜áŸ’ášá¶á™
                                </button>
                                <p className="text-xs text-center text-gray-500 mt-4">Free Mode: á”áŸ’ášá¾á”á¶á“á‡á¶á˜á½á™ Google Gemini</p>
                            </div>
                        )}

                        {step === 'main' && (
                            <div className="space-y-6 mt-6">
                                {/* UPLOAD BOX */}
                                <div className="border-2 border-dashed border-slate-700 rounded-2xl p-6 bg-slate-800/50 text-center relative group hover:border-yellow-500 transition">
                                    {!videoUrl ? (
                                        <>
                                            <div className="mx-auto w-12 h-12 text-slate-500 mb-2 group-hover:text-yellow-400"><Icons.Upload /></div>
                                            <p className="text-slate-300 font-medium">áŠá¶á€áŸ‹áœá¸áŠáŸá¢á¼á…á·á“á“áŸ…á‘á¸á“áŸáŸ‡</p>
                                            <p className="text-xs text-slate-500 mt-1">MP4 (Max 20MB)</p>
                                        </>
                                    ) : (
                                        <div className="relative aspect-video bg-black rounded-lg overflow-hidden">
                                            <video ref={videoRef} src={videoUrl} className="w-full h-full object-contain" controls />
                                        </div>
                                    )}
                                    <input type="file" accept="video/*" onChange={handleFileChange} className="absolute inset-0 opacity-0 cursor-pointer" />
                                </div>

                                {/* SCAN BUTTON & STATUS */}
                                <div>
                                    {status && (
                                        <div className={`text-center text-sm font-mono mb-2 p-2 rounded ${status.includes('âŒ') ? 'bg-red-900/30 text-red-400' : 'bg-green-900/30 text-green-400'}`}>
                                            {status}
                                        </div>
                                    )}
                                    
                                    <button 
                                        onClick={handleRealProcess}
                                        disabled={isProcessing || !videoUrl}
                                        className={`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg transition ${
                                            isProcessing || !videoUrl 
                                            ? 'bg-slate-700 text-slate-500 cursor-not-allowed' 
                                            : 'bg-gradient-to-r from-yellow-500 to-orange-600 text-black hover:scale-[1.02]'
                                        }`}
                                    >
                                        {isProcessing ? 'â³ á€áŸ†á–á»á„áŸá˜áŸ’ášá¶á™...' : 'ğŸ¿ á…á¶á”áŸ‹á•áŸ’áá¾á˜áŸá˜áŸ’ášá¶á™ášá¿á„'}
                                    </button>

                                    {modelName && (
                                        <div className="text-center mt-2 text-[10px] text-slate-500">
                                            Using: <span className="text-yellow-400 font-mono">{modelName}</span>
                                        </div>
                                    )}
                                </div>

                                {/* RESULT BOX */}
                                {translatedText && (
                                    <div className="bg-slate-800 rounded-2xl p-5 border border-slate-700 animate-fade-in shadow-2xl">
                                        <div className="flex justify-between items-center mb-3 pb-3 border-b border-slate-700">
                                            <h3 className="font-bold text-yellow-400">ğŸ“œ á¢ááŸ’áá”á‘áŸá˜áŸ’ášá¶á™</h3>
                                            <button onClick={handlePlayResult} className="bg-yellow-500 hover:bg-yellow-600 text-black px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                                <Icons.Play /> áŸáŸ’áá¶á”áŸ‹áŸáŸ†á¡áŸá„
                                            </button>
                                        </div>
                                        <div className="text-gray-200 leading-8 font-khmer text-justify max-h-80 overflow-y-auto pr-2 custom-scrollbar text-lg">
                                            {translatedText}
                                        </div>
                                    </div>
                                )}
                                
                                {translatedText && (
                                     <button onClick={() => window.location.reload()} className="w-full py-3 bg-slate-800 text-slate-400 rounded-xl font-medium hover:bg-slate-700 transition">
                                        á’áŸ’áœá¾áœá¸áŠáŸá¢á¼ááŸ’á˜á¸
                                    </button>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
